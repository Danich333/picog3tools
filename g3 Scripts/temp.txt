param(
    [string]$DeviceId = $null
)

# Update Path for ADB
$env:Path += ";$(Split-Path -Parent (Split-Path -Parent $MyInvocation.MyCommand.Definition))\platform-tools"

# Determine ADB Command
if ($DeviceId) {
    $Command = "adb -s $DeviceId"
} else {
    $Command = "adb"
}

# Define log file
$logFile = Join-Path (Split-Path -Parent $MyInvocation.MyCommand.Definition) "output_log.txt"

# Initialize log with header
"Device                OS Version           WiFi Status" | Out-File -FilePath $logFile -Encoding UTF8

# Get connected devices
$deviceList = (& adb devices | ForEach-Object { $_ -match "^([A-Za-z0-9]+)\s+device$" | Out-Null; $Matches[1] }) -ne $null

if (-not $deviceList) {
    "No devices connected. Exiting." | Out-File -FilePath $logFile -Append
    Invoke-Expression "notepad.exe $logFile"
    exit
}

# Process each device
foreach ($DeviceId in $deviceList) {
    # Build command for each device
    $Command = "adb -s $DeviceId"

    # Get Wi-Fi Status
    $wifiStatusOutput = & $Command shell dumpsys wifi | Select-String -Pattern "state: CONNECTED"
    if ($wifiStatusOutput) {
        $wifiStatus = "Connected"
    } else {
        $wifiStatus = "Not Connected"
    }

    # Get OS Version
    $osVersion = & $Command shell getprop ro.system.build.id

    # Format and append to log
    $entry = "{0,-20} {1,-20} {2,-20}" -f $DeviceId, $osVersion, $wifiStatus
    $entry | Out-File -FilePath $logFile -Append
}

# Open log file in Notepad
Invoke-Expression "notepad.exe $logFile"
pause